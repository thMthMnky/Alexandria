<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
  var DIALOG_DIMENSIONS = {
    width: 600,
    height: 425
  };

  var pickerApiLoaded = false;

  /**
   * Run initializations on sidebar load.
   */
  $(function () {
    // Assign handler functions to sidebar elements here, if needed.
    $('#gas_ss_get').click(onClick);

  });

  function onClick() {
    this.disabled = true;


    google.script.run.withSuccessHandler(createPicker)
      .withFailureHandler(showStatus)
      .withUserObject(this)
      .getOAuthToken();

  }

  function createPicker(token) {
    if (pickerApiLoaded && !!token) {

      var docsView = new google.picker.DocsView()
        .setIncludeFolders(true)
        .setMimeTypes('application/vnd.google-apps.folder')
        .setSelectFolderEnabled(true);

      var picker = new google.picker.PickerBuilder()
        .addView(docsView)
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .hideTitleBar()
        .setSize(DIALOG_DIMENSIONS.width - 2, DIALOG_DIMENSIONS.height - 2)
        .setOAuthToken(token)
        .setCallback(pickerCallback)
        .setOrigin('https://docs.google.com')
        .build();

      picker.setVisible(true);

    } else {
      showStatus('Unable to load the file picker.', classId)
    }
  }

  /**
   * A callback function that extracts the chosen document's metadata from the
   * response object. For details on the response object, see
   * https://developers.google.com/picker/docs/result
   *
   * @param {object} data The response object.
   */
  function pickerCallback(data) {
    var action = data[google.picker.Response.ACTION];
    if (action == google.picker.Action.PICKED) {
      //  var doc = data[google.picker.Response.DOCUMENTS][0];
      //  var id = doc[google.picker.Document.ID];
      showStatus(`First item: ${id}`);
            
    google.script.run
      .withSuccessHandler(
        handleDriveData
      )
      .withFailureHandler(
        function (msg, element) {
          // Respond to failure conditions here.
          showStatus(msg, 'error');
          element.disabled = false;
        }
      )
      .withUserObject(this)
      .getAllDriveData(); 
    } else if (action == google.picker.Action.CANCEL) {
      google.script.host.close();
    }
  }

  function handleDriveData(data) {
    var DriveData = data? data: {allFiles: [], allFolders: []};
    if( !!DriveData.allFiles && !!DriveData.allFolders && DriveData.allFiles.constructor.name === "array" && DriveData.allFolders.constructor.name === "array"){
      showStatus('YOU GOT THHE DRIVE DATA!! GOOOD JOB')
    }
  }
  /**
   * Displays the given status message in the sidebar.
   *
   * @param {String} msg The status message to display.
   * @param {String} classId The message type (class id) that the message
   *   should be displayed as.
   */
  function showStatus(msg, classId) {
    $('#sidebar-status').removeClass().html(msg);
    if (classId) {
      $('#sidebar-status').addClass(classId);
    }
  }
</script>